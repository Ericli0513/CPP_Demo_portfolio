name: C++ Multi-Project CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build tools
      run: sudo apt update && sudo apt install build-essential -y

    # === cpp-pipeline-demo ===
    - name: Build cpp-pipeline-demo
      run: make
      working-directory: cpp-pipeline-demo

    - name: Run cpp-pipeline-demo
      run: ./demo   # 假設執行檔叫 demo
      working-directory: cpp-pipeline-demo

    - name: Upload cpp-pipeline-demo artifact
      uses: actions/upload-artifact@v4
      with:
        name: cpp-pipeline-demo
        path: |
          cpp-pipeline-demo/demo

    # === driver_test_project ===
    - name: Build driver_test_project
      run: make
      working-directory: driver_test_project

    - name: Run driver_test_project
      run: ./driver_test   # 假設執行檔叫 driver_test
      working-directory: driver_test_project

    - name: Upload driver_test_project artifact
      uses: actions/upload-artifact@v4
      with:
        name: driver-test
        path: |
          driver_test_project/driver-test

    # === module_integration_project1 ===
    - name: Build module_integration_project1
      run: make
      working-directory: module_integration_project1

    - name: Run module_integration_project1
      run: ./module_test   # 
      working-directory: module_integration_project1

    - name: Upload module_integration_project1 artifact
      uses: actions/upload-artifact@v4
      with:
        name: module1
        path: |
          module_integration_project1/module1

    # === module_integration_project2 ===
    - name: Build module_integration_project2
      run: make
      working-directory: module_integration_project2

    - name: Run module_integration_project2
      run: ./module_tool load video
           ./module_tool load audio
            ./module_tool unload video
            ./module_tool unload audio
            ./module_tool load network
            ./module_tool unload network  #
      working-directory: module_integration_project2

    - name: Upload module_integration_project2 artifact
      uses: actions/upload-artifact@v4
      with:
        name: module2
        path: |
          module_integration_project2/module2

    # === sys_monitor_project ===
    - name: Build sys_monitor_project
      run: make
      working-directory: sys_monitor_project

    - name: Run sys_monitor_project
      run: ./sys_monitor   # 假設執行檔叫 sys_monitor
      working-directory: sys_monitor_project

    - name: Upload sys_monitor_project artifact
      uses: actions/upload-artifact@v4
      with:
        name: sys-monitor
        path: |
          sys_monitor_project/sys-monitor

    # === tv_integration_project ===
    - name: Build tv_integration_project
      run: make
      working-directory: tv_integration_project

    - name: Run tv_integration_project
      run: ./tv_test   # 假設執行檔叫 tv_test
      working-directory: tv_integration_project

    - name: Upload tv_integration_project artifact
      uses: actions/upload-artifact@v4
      with:
        name: tv-integration
        path: |
          tv_integration_project/tv-integration
